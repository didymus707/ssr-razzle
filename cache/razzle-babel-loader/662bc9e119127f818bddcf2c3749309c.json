{"ast":null,"code":"const _excluded = [\"file\"];\nvar _jsxFileName = \"/Users/public1/Documents/Projects/ssr-razzle/src/app/authenticated-app/marketing/coupons/components/view-coupon.tsx\";\nvar __jsx = React.createElement;\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) { symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); } keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nfunction _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\nimport { Box, useToast } from '@chakra-ui/core';\nimport React, { useCallback } from 'react';\nimport { useMutation, useQuery } from 'react-query';\nimport { useDispatch, useSelector } from 'react-redux';\nimport { useHistory, useParams } from 'react-router';\nimport { toFormData } from 'utils';\nimport { ContentWrapper, FullPageSpinner, ToastBox } from '../../../../components';\nimport { selectLists, selectListsById, selectSmartLists, selectSmartListsById } from '../../../lists';\nimport { fetchWallet } from '../../../payments';\nimport { selectCreditBalance } from '../../../payments/selectors';\nimport { editTemplate, fetchSampleTemplates, fetchTemplates, selectTemplateCategories } from '../../templates';\nimport { campaignImport, Design, fetchCampaignItem, FlowSteps, SectionContainer, SectionHeader, updateCampaignItem } from '../../campaigns';\nimport { CouponReview } from './coupon-review';\nimport { CouponSetup } from './coupon-setup';\nexport const ViewCoupon = () => {\n  var _data$data$campaign, _data$data;\n\n  const toast = useToast();\n  const history = useHistory();\n  const dispatch = useDispatch();\n  const {\n    id: routeID\n  } = useParams();\n  const lists = useSelector(selectLists);\n  const smart_lists = useSelector(selectSmartLists);\n  const lists_by_id = useSelector(selectListsById);\n  const smart_lists_by_id = useSelector(selectSmartListsById);\n  const credit_balance = useSelector(selectCreditBalance);\n  const templateCategories = useSelector(selectTemplateCategories);\n  const {\n    data,\n    isLoading\n  } = useQuery(['coupon', routeID], () => fetchCampaignItem(routeID));\n  const [section, setSection] = React.useState(0);\n  const [payload, setPayload] = React.useState((_data$data$campaign = data === null || data === void 0 ? void 0 : (_data$data = data.data) === null || _data$data === void 0 ? void 0 : _data$data.campaign) !== null && _data$data$campaign !== void 0 ? _data$data$campaign : {});\n  const listOptions = lists_by_id //@ts-ignore\n  .map(id => lists[id]).map(({\n    name,\n    id\n  }) => ({\n    label: name,\n    value: id\n  }));\n  const smartListOptions = smart_lists_by_id //@ts-ignore\n  .map(id => smart_lists[id]).map(({\n    name,\n    id\n  }) => ({\n    label: name,\n    value: `${id}-smartList`\n  }));\n  const allLists = [{\n    label: 'Lists',\n    options: listOptions,\n    showBadge: true\n  }, {\n    label: 'Smart lists',\n    options: smartListOptions,\n    showBadge: true\n  }];\n  const {\n    mutate,\n    isLoading: isSaving\n  } = useMutation(payload => updateCampaignItem(payload), {\n    onSuccess: () => {\n      toast({\n        position: 'bottom-left',\n        render: ({\n          onClose\n        }) => __jsx(ToastBox, {\n          status: \"success\",\n          onClose: onClose,\n          message: \"Campaign created successfully\",\n          __self: this,\n          __source: {\n            fileName: _jsxFileName,\n            lineNumber: 78,\n            columnNumber: 13\n          }\n        })\n      });\n      history.push('/s/marketing/coupons');\n    },\n    onError: (error, newData, context) => {\n      toast({\n        position: 'bottom-left',\n        render: ({\n          onClose\n        }) => __jsx(ToastBox, {\n          onClose: onClose,\n          message: error.message,\n          __self: this,\n          __source: {\n            fileName: _jsxFileName,\n            lineNumber: 86,\n            columnNumber: 36\n          }\n        })\n      });\n    }\n  });\n\n  const handleCancel = () => history.goBack();\n\n  const handleCreateCoupon = async payload => {\n    const {\n      file\n    } = payload,\n          rest = _objectWithoutProperties(payload, _excluded);\n\n    try {\n      const importPayload = toFormData({\n        name: file.name,\n        delimiter: 'comma',\n        source: 'csv'\n      }, file, 'file');\n      const {\n        data\n      } = await campaignImport(importPayload);\n      mutate(_objectSpread(_objectSpread({}, rest), {}, {\n        import_id: data.import.id\n      }));\n    } catch (error) {\n      console.log(error);\n    }\n  };\n\n  const handleGoBack = () => {\n    setSection(section - 1);\n  };\n\n  const handleGoToSection = section => {\n    setSection(section);\n  };\n\n  const handleSubmit = data => {\n    setPayload(_objectSpread(_objectSpread({}, payload), data));\n    setSection(section + 1);\n  };\n\n  const handleFetchWallet = useCallback(organisationId => {\n    if (organisationId) {\n      dispatch(fetchWallet(organisationId));\n    }\n  }, [dispatch]);\n  const handleFetchTemplates = useCallback(async () => {\n    return await dispatch(fetchTemplates());\n  }, [dispatch]);\n  const handleFetchSampleTemplates = useCallback(async payload => {\n    return await dispatch(fetchSampleTemplates(payload));\n  }, [dispatch]);\n  const handleUpdateTemplate = useCallback(async payload => {\n    try {\n      dispatch(editTemplate(payload));\n    } catch (error) {\n      toast({\n        position: 'bottom-left',\n        render: ({\n          onClose\n        }) => __jsx(ToastBox, {\n          onClose: onClose,\n          message: error,\n          __self: this,\n          __source: {\n            fileName: _jsxFileName,\n            lineNumber: 149,\n            columnNumber: 36\n          }\n        })\n      });\n    }\n  }, [dispatch, toast]);\n\n  if (isLoading) {\n    return __jsx(FullPageSpinner, {\n      bg: \"white\",\n      height: \"100vh\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 157,\n        columnNumber: 12\n      }\n    });\n  }\n\n  return __jsx(ContentWrapper, {\n    p: \"1.875rem\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 161,\n      columnNumber: 5\n    }\n  }, __jsx(SectionContainer, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 162,\n      columnNumber: 7\n    }\n  }, __jsx(Box, {\n    pb: \"2rem\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 163,\n      columnNumber: 9\n    }\n  }, __jsx(SectionHeader, {\n    pb: \"1rem\",\n    heading: 'Create your coupon set',\n    subheading: 'Give your coupon a name and choose who to send to.',\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 164,\n      columnNumber: 11\n    }\n  }), __jsx(FlowSteps, {\n    activeSection: section,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 171,\n      columnNumber: 11\n    }\n  })), section === 0 && __jsx(CouponSetup, {\n    lists: allLists,\n    initialValues: payload,\n    onCancel: handleCancel,\n    onSubmit: handleSubmit,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 174,\n      columnNumber: 11\n    }\n  }), section === 1 && __jsx(Design, {\n    onGoBack: handleGoBack,\n    onSubmit: handleSubmit,\n    initialValues: payload,\n    fetchWallet: handleFetchWallet,\n    credit_balance: credit_balance,\n    fetchTemplates: handleFetchTemplates,\n    templateCategories: templateCategories,\n    handleUpdateTemplate: handleUpdateTemplate,\n    fetchSampleTemplates: handleFetchSampleTemplates,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 182,\n      columnNumber: 11\n    }\n  }), section === 2 && __jsx(CouponReview, {\n    payload: payload,\n    isSaving: isSaving,\n    onGoBack: handleGoBack,\n    onSubmit: handleCreateCoupon,\n    credit_balance: credit_balance,\n    onGoToSection: handleGoToSection,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 195,\n      columnNumber: 11\n    }\n  })));\n};","map":{"version":3,"sources":["/Users/public1/Documents/Projects/ssr-razzle/src/app/authenticated-app/marketing/coupons/components/view-coupon.tsx"],"names":["Box","useToast","React","useCallback","useMutation","useQuery","useDispatch","useSelector","useHistory","useParams","toFormData","ContentWrapper","FullPageSpinner","ToastBox","selectLists","selectListsById","selectSmartLists","selectSmartListsById","fetchWallet","selectCreditBalance","editTemplate","fetchSampleTemplates","fetchTemplates","selectTemplateCategories","campaignImport","Design","fetchCampaignItem","FlowSteps","SectionContainer","SectionHeader","updateCampaignItem","CouponReview","CouponSetup","ViewCoupon","toast","history","dispatch","id","routeID","lists","smart_lists","lists_by_id","smart_lists_by_id","credit_balance","templateCategories","data","isLoading","section","setSection","useState","payload","setPayload","campaign","listOptions","map","name","label","value","smartListOptions","allLists","options","showBadge","mutate","isSaving","onSuccess","position","render","onClose","push","onError","error","newData","context","message","handleCancel","goBack","handleCreateCoupon","file","rest","importPayload","delimiter","source","import_id","import","console","log","handleGoBack","handleGoToSection","handleSubmit","handleFetchWallet","organisationId","handleFetchTemplates","handleFetchSampleTemplates","handleUpdateTemplate","heading","subheading"],"mappings":"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","sourcesContent":["import { Box, useToast } from '@chakra-ui/core';\nimport { AxiosError } from 'axios';\nimport React, { useCallback } from 'react';\nimport { useMutation, useQuery } from 'react-query';\nimport { useDispatch, useSelector } from 'react-redux';\nimport { useHistory, useParams } from 'react-router';\nimport { toFormData } from 'utils';\nimport { ContentWrapper, FullPageSpinner, ToastBox } from '../../../../components';\nimport {\n  selectLists,\n  selectListsById,\n  selectSmartLists,\n  selectSmartListsById,\n} from '../../../lists';\nimport { fetchWallet } from '../../../payments';\nimport { selectCreditBalance } from '../../../payments/selectors';\nimport {\n  editTemplate,\n  fetchSampleTemplates,\n  fetchTemplates,\n  selectTemplateCategories,\n  TemplateData,\n} from '../../templates';\nimport {\n  campaignImport,\n  Design,\n  fetchCampaignItem,\n  FlowSteps,\n  SectionContainer,\n  SectionHeader,\n  updateCampaignItem,\n} from '../../campaigns';\nimport { CampaignData } from '../../campaigns/campaigns.types';\nimport { CouponReview } from './coupon-review';\nimport { CouponSetup } from './coupon-setup';\nimport { CouponPayload } from './create-coupon';\n\nexport const ViewCoupon = () => {\n  const toast = useToast();\n  const history = useHistory();\n  const dispatch = useDispatch();\n  const { id: routeID } = useParams<{ id: CampaignData['id'] }>();\n\n  const lists = useSelector(selectLists);\n  const smart_lists = useSelector(selectSmartLists);\n  const lists_by_id = useSelector(selectListsById);\n  const smart_lists_by_id = useSelector(selectSmartListsById);\n  const credit_balance = useSelector(selectCreditBalance);\n  const templateCategories = useSelector(selectTemplateCategories);\n\n  const { data, isLoading } = useQuery(['coupon', routeID], () => fetchCampaignItem(routeID));\n\n  const [section, setSection] = React.useState(0);\n  const [payload, setPayload] = React.useState<CouponPayload>(data?.data?.campaign ?? {});\n\n  const listOptions = lists_by_id\n    //@ts-ignore\n    .map((id: string) => lists[id])\n    .map(({ name, id }) => ({ label: name, value: id }));\n\n  const smartListOptions = smart_lists_by_id\n    //@ts-ignore\n    .map((id: string) => smart_lists[id])\n    .map(({ name, id }) => ({ label: name, value: `${id}-smartList` }));\n\n  const allLists = [\n    { label: 'Lists', options: listOptions, showBadge: true },\n    { label: 'Smart lists', options: smartListOptions, showBadge: true },\n  ];\n\n  const { mutate, isLoading: isSaving } = useMutation<any, AxiosError, any, any>(\n    (payload: CouponPayload) => updateCampaignItem(payload),\n    {\n      onSuccess: () => {\n        toast({\n          position: 'bottom-left',\n          render: ({ onClose }) => (\n            <ToastBox status=\"success\" onClose={onClose} message=\"Campaign created successfully\" />\n          ),\n        });\n        history.push('/s/marketing/coupons');\n      },\n      onError: (error, newData, context) => {\n        toast({\n          position: 'bottom-left',\n          render: ({ onClose }) => <ToastBox onClose={onClose} message={error.message} />,\n        });\n      },\n    },\n  );\n\n  const handleCancel = () => history.goBack();\n\n  const handleCreateCoupon = async (payload: Partial<CouponPayload>) => {\n    const { file, ...rest } = payload;\n    try {\n      const importPayload = toFormData(\n        { name: file.name, delimiter: 'comma', source: 'csv' },\n        file,\n        'file',\n      );\n      const { data } = await campaignImport(importPayload);\n      mutate({ ...rest, import_id: data.import.id });\n    } catch (error) {\n      console.log(error);\n    }\n  };\n\n  const handleGoBack = () => {\n    setSection(section - 1);\n  };\n\n  const handleGoToSection = (section: number) => {\n    setSection(section);\n  };\n\n  const handleSubmit = (data: any) => {\n    setPayload({ ...payload, ...data });\n    setSection(section + 1);\n  };\n\n  const handleFetchWallet = useCallback(\n    organisationId => {\n      if (organisationId) {\n        dispatch(fetchWallet(organisationId));\n      }\n    },\n    [dispatch],\n  );\n\n  const handleFetchTemplates = useCallback(async () => {\n    return await dispatch(fetchTemplates());\n  }, [dispatch]);\n\n  const handleFetchSampleTemplates = useCallback(\n    async payload => {\n      return await dispatch(fetchSampleTemplates(payload));\n    },\n    [dispatch],\n  );\n\n  const handleUpdateTemplate = useCallback(\n    async (payload: TemplateData) => {\n      try {\n        dispatch(editTemplate(payload));\n      } catch (error) {\n        toast({\n          position: 'bottom-left',\n          render: ({ onClose }) => <ToastBox onClose={onClose} message={error} />,\n        });\n      }\n    },\n    [dispatch, toast],\n  );\n\n  if (isLoading) {\n    return <FullPageSpinner bg=\"white\" height=\"100vh\" />;\n  }\n\n  return (\n    <ContentWrapper p=\"1.875rem\">\n      <SectionContainer>\n        <Box pb=\"2rem\">\n          <SectionHeader\n            pb=\"1rem\"\n            {...{\n              heading: 'Create your coupon set',\n              subheading: 'Give your coupon a name and choose who to send to.',\n            }}\n          />\n          <FlowSteps activeSection={section} />\n        </Box>\n        {section === 0 && (\n          <CouponSetup\n            lists={allLists}\n            initialValues={payload}\n            onCancel={handleCancel}\n            onSubmit={handleSubmit}\n          />\n        )}\n        {section === 1 && (\n          <Design\n            onGoBack={handleGoBack}\n            onSubmit={handleSubmit}\n            initialValues={payload}\n            fetchWallet={handleFetchWallet}\n            credit_balance={credit_balance}\n            fetchTemplates={handleFetchTemplates}\n            templateCategories={templateCategories}\n            handleUpdateTemplate={handleUpdateTemplate}\n            fetchSampleTemplates={handleFetchSampleTemplates}\n          />\n        )}\n        {section === 2 && (\n          <CouponReview\n            payload={payload}\n            isSaving={isSaving}\n            onGoBack={handleGoBack}\n            onSubmit={handleCreateCoupon}\n            credit_balance={credit_balance}\n            onGoToSection={handleGoToSection}\n          />\n        )}\n      </SectionContainer>\n    </ContentWrapper>\n  );\n};\n"]},"metadata":{},"sourceType":"module"}