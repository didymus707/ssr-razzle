{"ast":null,"code":"const _excluded = [\"file\"];\nvar _jsxFileName = \"/Users/public1/Documents/Projects/ssr-razzle/src/app/authenticated-app/marketing/coupons/components/create-coupon.tsx\";\nvar __jsx = React.createElement;\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) { symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); } keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nfunction _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\nimport { Box, useToast } from '@chakra-ui/core';\nimport React, { useCallback } from 'react';\nimport { useMutation } from 'react-query';\nimport { useDispatch, useSelector } from 'react-redux';\nimport { useHistory } from 'react-router';\nimport { toFormData } from 'utils';\nimport { ContentWrapper, ToastBox } from '../../../../components';\nimport { selectLists, selectListsById, selectSegments, selectSmartLists, selectSmartListsById } from '../../../lists';\nimport { fetchWallet } from '../../../payments';\nimport { selectCreditBalance } from '../../../payments/selectors';\nimport { editTemplate, fetchSampleTemplates, fetchTemplates, selectTemplateCategories } from '../../templates';\nimport { campaignImport, createCoupon, Design, FlowSteps, SectionContainer, SectionHeader } from '../../campaigns';\nimport { CouponReview } from './coupon-review';\nimport { CouponSetup } from './coupon-setup';\nexport const CreateCoupon = () => {\n  const toast = useToast();\n  const history = useHistory();\n  const dispatch = useDispatch();\n  const lists = useSelector(selectLists);\n  const segments = useSelector(selectSegments);\n  const smart_lists = useSelector(selectSmartLists);\n  const lists_by_id = useSelector(selectListsById);\n  const smart_lists_by_id = useSelector(selectSmartListsById);\n  const credit_balance = useSelector(selectCreditBalance);\n  const templateCategories = useSelector(selectTemplateCategories);\n  const [section, setSection] = React.useState(0);\n  const [payload, setPayload] = React.useState({\n    unique: true,\n    content: 'Use this {{coupon}}'\n  });\n  const listOptions = lists_by_id //@ts-ignore\n  .map(id => lists[id]).map(({\n    name,\n    id\n  }) => ({\n    label: name,\n    value: id\n  }));\n  const smartListOptions = smart_lists_by_id //@ts-ignore\n  .map(id => smart_lists[id]).map(({\n    name,\n    id\n  }) => ({\n    label: name,\n    value: `${id}-smartList`\n  }));\n  const segmentOptions = segments.map(({\n    name,\n    id\n  }) => ({\n    label: name,\n    value: `${id}-segment`\n  }));\n  const allLists = [{\n    label: 'Lists',\n    options: listOptions,\n    showBadge: true\n  }, {\n    label: 'Smart lists',\n    options: smartListOptions,\n    showBadge: true\n  }, {\n    label: 'Segments',\n    options: segmentOptions,\n    showBadge: true\n  }];\n  const {\n    mutate,\n    isLoading\n  } = useMutation(payload => createCoupon(payload), {\n    onSuccess: () => {\n      toast({\n        position: 'bottom-left',\n        render: ({\n          onClose\n        }) => __jsx(ToastBox, {\n          status: \"success\",\n          onClose: onClose,\n          message: \"Campaign created successfully\",\n          __self: this,\n          __source: {\n            fileName: _jsxFileName,\n            lineNumber: 95,\n            columnNumber: 13\n          }\n        })\n      });\n      history.push('/s/marketing/coupons');\n    },\n    onError: (error, newData, context) => {\n      toast({\n        position: 'bottom-left',\n        render: ({\n          onClose\n        }) => __jsx(ToastBox, {\n          onClose: onClose,\n          message: error.message,\n          __self: this,\n          __source: {\n            fileName: _jsxFileName,\n            lineNumber: 103,\n            columnNumber: 36\n          }\n        })\n      });\n    }\n  });\n\n  const handleCancel = () => history.goBack();\n\n  const handleCreateCoupon = async payload => {\n    const {\n      file\n    } = payload,\n          rest = _objectWithoutProperties(payload, _excluded);\n\n    try {\n      const importPayload = toFormData({\n        name: file.name,\n        delimiter: 'comma',\n        source: 'csv'\n      }, file, 'file');\n      const {\n        data\n      } = await campaignImport(importPayload);\n      mutate(_objectSpread(_objectSpread({}, rest), {}, {\n        import_id: data.import.id,\n        type: 'coupon'\n      }));\n    } catch (error) {\n      console.log(error);\n    }\n  };\n\n  const handleGoBack = () => {\n    setSection(section - 1);\n  };\n\n  const handleGoToSection = section => {\n    setSection(section);\n  };\n\n  const handleSubmit = data => {\n    setPayload(_objectSpread(_objectSpread({}, payload), data));\n    setSection(section + 1);\n  };\n\n  const handleFetchWallet = useCallback(organisationId => {\n    if (organisationId) {\n      dispatch(fetchWallet(organisationId));\n    }\n  }, [dispatch]);\n  const handleFetchTemplates = useCallback(async () => {\n    return await dispatch(fetchTemplates());\n  }, [dispatch]);\n  const handleFetchSampleTemplates = useCallback(async payload => {\n    return await dispatch(fetchSampleTemplates(payload));\n  }, [dispatch]);\n  const handleUpdateTemplate = useCallback(async payload => {\n    try {\n      dispatch(editTemplate(payload));\n    } catch (error) {\n      toast({\n        position: 'bottom-left',\n        render: ({\n          onClose\n        }) => __jsx(ToastBox, {\n          onClose: onClose,\n          message: error,\n          __self: this,\n          __source: {\n            fileName: _jsxFileName,\n            lineNumber: 166,\n            columnNumber: 36\n          }\n        })\n      });\n    }\n  }, [dispatch, toast]);\n  return __jsx(ContentWrapper, {\n    p: \"1.875rem\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 174,\n      columnNumber: 5\n    }\n  }, __jsx(SectionContainer, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 175,\n      columnNumber: 7\n    }\n  }, __jsx(Box, {\n    pb: \"2rem\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 176,\n      columnNumber: 9\n    }\n  }, __jsx(SectionHeader, {\n    pb: \"1rem\",\n    heading: 'Create your coupon set',\n    subheading: 'Give your coupon a name and choose who to send to.',\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 177,\n      columnNumber: 11\n    }\n  }), __jsx(FlowSteps, {\n    activeSection: section,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 184,\n      columnNumber: 11\n    }\n  })), section === 0 && __jsx(CouponSetup, {\n    lists: allLists,\n    initialValues: payload,\n    onCancel: handleCancel,\n    onSubmit: handleSubmit,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 187,\n      columnNumber: 11\n    }\n  }), section === 1 && __jsx(Design, {\n    onGoBack: handleGoBack,\n    onSubmit: handleSubmit,\n    initialValues: payload,\n    fetchWallet: handleFetchWallet,\n    credit_balance: credit_balance,\n    fetchTemplates: handleFetchTemplates,\n    templateCategories: templateCategories,\n    handleUpdateTemplate: handleUpdateTemplate,\n    fetchSampleTemplates: handleFetchSampleTemplates,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 195,\n      columnNumber: 11\n    }\n  }), section === 2 && __jsx(CouponReview, {\n    payload: payload,\n    isSaving: isLoading,\n    onGoBack: handleGoBack,\n    onSubmit: handleCreateCoupon,\n    credit_balance: credit_balance,\n    onGoToSection: handleGoToSection,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 208,\n      columnNumber: 11\n    }\n  })));\n};","map":{"version":3,"sources":["/Users/public1/Documents/Projects/ssr-razzle/src/app/authenticated-app/marketing/coupons/components/create-coupon.tsx"],"names":["Box","useToast","React","useCallback","useMutation","useDispatch","useSelector","useHistory","toFormData","ContentWrapper","ToastBox","selectLists","selectListsById","selectSegments","selectSmartLists","selectSmartListsById","fetchWallet","selectCreditBalance","editTemplate","fetchSampleTemplates","fetchTemplates","selectTemplateCategories","campaignImport","createCoupon","Design","FlowSteps","SectionContainer","SectionHeader","CouponReview","CouponSetup","CreateCoupon","toast","history","dispatch","lists","segments","smart_lists","lists_by_id","smart_lists_by_id","credit_balance","templateCategories","section","setSection","useState","payload","setPayload","unique","content","listOptions","map","id","name","label","value","smartListOptions","segmentOptions","allLists","options","showBadge","mutate","isLoading","onSuccess","position","render","onClose","push","onError","error","newData","context","message","handleCancel","goBack","handleCreateCoupon","file","rest","importPayload","delimiter","source","data","import_id","import","type","console","log","handleGoBack","handleGoToSection","handleSubmit","handleFetchWallet","organisationId","handleFetchTemplates","handleFetchSampleTemplates","handleUpdateTemplate","heading","subheading"],"mappings":"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","sourcesContent":["import { Box, useToast } from '@chakra-ui/core';\nimport { AxiosError } from 'axios';\nimport React, { useCallback } from 'react';\nimport { useMutation } from 'react-query';\nimport { useDispatch, useSelector } from 'react-redux';\nimport { useHistory } from 'react-router';\nimport { toFormData } from 'utils';\nimport { ContentWrapper, ToastBox } from '../../../../components';\nimport {\n  selectLists,\n  selectListsById,\n  selectSegments,\n  selectSmartLists,\n  selectSmartListsById,\n} from '../../../lists';\nimport { fetchWallet } from '../../../payments';\nimport { selectCreditBalance } from '../../../payments/selectors';\nimport {\n  editTemplate,\n  fetchSampleTemplates,\n  fetchTemplates,\n  selectTemplateCategories,\n  TemplateData,\n} from '../../templates';\nimport {\n  campaignImport,\n  createCoupon,\n  Design,\n  FlowSteps,\n  SectionContainer,\n  SectionHeader,\n} from '../../campaigns';\nimport { CouponReview } from './coupon-review';\nimport { CouponSetup } from './coupon-setup';\n\nexport type CouponPayload = {\n  file?: any;\n  type?: string;\n  name?: string;\n  count?: number;\n  unique?: boolean;\n  content?: string;\n  table_id?: string;\n  sender_id?: string;\n  import_id?: string;\n  segment_id?: string;\n  timezone?: string;\n  smart_list_id?: string;\n  audience_id?: string | null;\n};\n\nexport const CreateCoupon = () => {\n  const toast = useToast();\n  const history = useHistory();\n  const dispatch = useDispatch();\n  const lists = useSelector(selectLists);\n  const segments = useSelector(selectSegments);\n  const smart_lists = useSelector(selectSmartLists);\n  const lists_by_id = useSelector(selectListsById);\n  const smart_lists_by_id = useSelector(selectSmartListsById);\n  const credit_balance = useSelector(selectCreditBalance);\n  const templateCategories = useSelector(selectTemplateCategories);\n\n  const [section, setSection] = React.useState(0);\n  const [payload, setPayload] = React.useState<CouponPayload>({\n    unique: true,\n    content: 'Use this {{coupon}}',\n  });\n\n  const listOptions = lists_by_id\n    //@ts-ignore\n    .map((id: string) => lists[id])\n    .map(({ name, id }) => ({ label: name, value: id }));\n\n  const smartListOptions = smart_lists_by_id\n    //@ts-ignore\n    .map((id: string) => smart_lists[id])\n    .map(({ name, id }) => ({ label: name, value: `${id}-smartList` }));\n\n  const segmentOptions = segments.map(({ name, id }) => ({ label: name, value: `${id}-segment` }));\n\n  const allLists = [\n    { label: 'Lists', options: listOptions, showBadge: true },\n    { label: 'Smart lists', options: smartListOptions, showBadge: true },\n    { label: 'Segments', options: segmentOptions, showBadge: true },\n  ];\n\n  const { mutate, isLoading } = useMutation<any, AxiosError, any, any>(\n    (payload: CouponPayload) => createCoupon(payload),\n    {\n      onSuccess: () => {\n        toast({\n          position: 'bottom-left',\n          render: ({ onClose }) => (\n            <ToastBox status=\"success\" onClose={onClose} message=\"Campaign created successfully\" />\n          ),\n        });\n        history.push('/s/marketing/coupons');\n      },\n      onError: (error, newData, context) => {\n        toast({\n          position: 'bottom-left',\n          render: ({ onClose }) => <ToastBox onClose={onClose} message={error.message} />,\n        });\n      },\n    },\n  );\n\n  const handleCancel = () => history.goBack();\n\n  const handleCreateCoupon = async (payload: Partial<CouponPayload>) => {\n    const { file, ...rest } = payload;\n    try {\n      const importPayload = toFormData(\n        { name: file.name, delimiter: 'comma', source: 'csv' },\n        file,\n        'file',\n      );\n      const { data } = await campaignImport(importPayload);\n      mutate({ ...rest, import_id: data.import.id, type: 'coupon' });\n    } catch (error) {\n      console.log(error);\n    }\n  };\n\n  const handleGoBack = () => {\n    setSection(section - 1);\n  };\n\n  const handleGoToSection = (section: number) => {\n    setSection(section);\n  };\n\n  const handleSubmit = (data: any) => {\n    setPayload({ ...payload, ...data });\n    setSection(section + 1);\n  };\n\n  const handleFetchWallet = useCallback(\n    organisationId => {\n      if (organisationId) {\n        dispatch(fetchWallet(organisationId));\n      }\n    },\n    [dispatch],\n  );\n\n  const handleFetchTemplates = useCallback(async () => {\n    return await dispatch(fetchTemplates());\n  }, [dispatch]);\n\n  const handleFetchSampleTemplates = useCallback(\n    async payload => {\n      return await dispatch(fetchSampleTemplates(payload));\n    },\n    [dispatch],\n  );\n\n  const handleUpdateTemplate = useCallback(\n    async (payload: TemplateData) => {\n      try {\n        dispatch(editTemplate(payload));\n      } catch (error) {\n        toast({\n          position: 'bottom-left',\n          render: ({ onClose }) => <ToastBox onClose={onClose} message={error} />,\n        });\n      }\n    },\n    [dispatch, toast],\n  );\n\n  return (\n    <ContentWrapper p=\"1.875rem\">\n      <SectionContainer>\n        <Box pb=\"2rem\">\n          <SectionHeader\n            pb=\"1rem\"\n            {...{\n              heading: 'Create your coupon set',\n              subheading: 'Give your coupon a name and choose who to send to.',\n            }}\n          />\n          <FlowSteps activeSection={section} />\n        </Box>\n        {section === 0 && (\n          <CouponSetup\n            lists={allLists}\n            initialValues={payload}\n            onCancel={handleCancel}\n            onSubmit={handleSubmit}\n          />\n        )}\n        {section === 1 && (\n          <Design\n            onGoBack={handleGoBack}\n            onSubmit={handleSubmit}\n            initialValues={payload}\n            fetchWallet={handleFetchWallet}\n            credit_balance={credit_balance}\n            fetchTemplates={handleFetchTemplates}\n            templateCategories={templateCategories}\n            handleUpdateTemplate={handleUpdateTemplate}\n            fetchSampleTemplates={handleFetchSampleTemplates}\n          />\n        )}\n        {section === 2 && (\n          <CouponReview\n            payload={payload}\n            isSaving={isLoading}\n            onGoBack={handleGoBack}\n            onSubmit={handleCreateCoupon}\n            credit_balance={credit_balance}\n            onGoToSection={handleGoToSection}\n          />\n        )}\n      </SectionContainer>\n    </ContentWrapper>\n  );\n};\n"]},"metadata":{},"sourceType":"module"}